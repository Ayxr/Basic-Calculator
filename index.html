<script>
  // --- CALCULATOR TABS ---
  const tabIds = ['basic', 'graphing', 'geometry', '3d', 'finance'];
  const tabPaths = {
    basic: '/',
    graphing: '/graphing/',
    geometry: '/geometry/',
    '3d': '/3D/',
    finance: '/finance/'
  };

  function showCalc(type, push = true) {
    tabIds.forEach(id => {
      document.getElementById('calc-' + id).style.display = (id === type) ? '' : 'none';
      document.getElementById('tab-' + id).classList.toggle('active', id === type);
    });
    if (push) {
      const path = tabPaths[type];
      if (window.location.pathname !== path) {
        window.history.pushState({calc: type}, '', path);
      }
    }
  }

  // Handle browser navigation (back/forward)
  window.addEventListener('popstate', function(event) {
    let type = 'basic';
    // Get type from state or path
    if (event.state && event.state.calc) {
      type = event.state.calc;
    } else {
      type = getCalcTypeFromPath(window.location.pathname);
    }
    showCalc(type, false);
  });

  function getCalcTypeFromPath(path) {
    path = path.toLowerCase();
    if (path === '/graphing/') return 'graphing';
    if (path === '/geometry/') return 'geometry';
    if (path === '/3d/' || path === '/3D/') return '3d';
    if (path === '/finance/') return 'finance';
    // Default (root or unknown): show basic
    return 'basic';
  }

  // On initial page load, set the correct tab based on URL
  (function initCalcFromPath() {
    const type = getCalcTypeFromPath(window.location.pathname);
    showCalc(type, false);
    // Ensure state is set for accurate popstate
    window.history.replaceState({calc: type}, '', tabPaths[type]);
  })();

  // (The rest of your script for calculators, theme toggle, etc, remains unchanged below)
  // --- BASIC CALCULATOR ---
  let display = document.getElementById('display');
  let currentInput = '';

  function press(val) {
    if (val === '.') {
      let parts = currentInput.split(/[\+\-\*\/]/);
      let last = parts[parts.length - 1];
      if (last.includes('.')) return;
    }
    currentInput += val;
    display.value = currentInput;
  }

  function clearDisplay() {
    currentInput = '';
    display.value = '';
  }

  function calculate() {
    try {
      let result = eval(currentInput.replace(/รท/g, '/').replace(/ร/g, '*'));
      display.value = result;
      currentInput = result.toString();
    } catch {
      display.value = 'Error';
      currentInput = '';
    }
  }

  // --- GRAPHING CALCULATOR ---
  let graphChart = null;
  function plotGraph() {
    const fnInput = document.getElementById('graph-function').value;
    const ctx = document.getElementById('graph-canvas').getContext('2d');
    let expression = fnInput.trim().toLowerCase().replace('y=', '').replace('^', '**');
    let xs = [], ys = [];
    for (let x = -10; x <= 10; x += 0.1) {
      let safeExpr = expression.replace(/x/g, `(${x})`);
      let y = NaN;
      try { y = eval(safeExpr); } catch {}
      xs.push(Number(x.toFixed(2)));
      ys.push(isNaN(y) ? null : y);
    }
    if (graphChart) graphChart.destroy();
    graphChart = new Chart(ctx, {
      type: 'line',
      data: { labels: xs, datasets: [{label: fnInput, data: ys, borderColor:'#4caf50', borderWidth:2, pointRadius:0, fill:false }] },
      options: {
        responsive: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { title: {display:true, text:'x'}, min: -10, max: 10, grid:{color:'#eee'} },
          y: { title: {display:true, text:'y'}, grid:{color:'#eee'} }
        }
      }
    });
  }

  // --- GEOMETRY CALCULATOR ---
  const geometryInputs = {
    circle: [{id:'radius', label:'Radius', type:'number'}],
    triangle: [
      {id:'base', label:'Base', type:'number'},
      {id:'height', label:'Height', type:'number'}
    ],
    rectangle: [
      {id:'width', label:'Width', type:'number'},
      {id:'height', label:'Height', type:'number'}
    ]
  };
  function renderGeometryInputs() {
    const shape = document.getElementById('geometry-shape').value;
    const container = document.getElementById('geometry-inputs');
    container.innerHTML = '';
    geometryInputs[shape].forEach(inp => {
      container.innerHTML += `<input id="geo-${inp.id}" type="${inp.type}" step="any" placeholder="${inp.label}" style="width:100%; margin-bottom:0.4rem; border-radius:6px; border:1px solid #ccc; padding:0.35rem 0.6rem;">`;
    });
  }
  document.getElementById('geometry-shape').addEventListener('change', renderGeometryInputs);
  renderGeometryInputs();

  function calcGeometry() {
    const shape = document.getElementById('geometry-shape').value;
    let result = '';
    if (shape === 'circle') {
      const r = parseFloat(document.getElementById('geo-radius').value);
      if (isNaN(r) || r <= 0) result = 'Please enter a positive radius.';
      else result = `Area: ${(Math.PI * r * r).toFixed(4)}, Circumference: ${(2 * Math.PI * r).toFixed(4)}`;
    } else if (shape === 'triangle') {
      const b = parseFloat(document.getElementById('geo-base').value);
      const h = parseFloat(document.getElementById('geo-height').value);
      if (isNaN(b) || b <= 0 || isNaN(h) || h <= 0) result = 'Enter positive base & height.';
      else result = `Area: ${(0.5 * b * h).toFixed(4)}`;
    } else if (shape === 'rectangle') {
      const w = parseFloat(document.getElementById('geo-width').value);
      const h = parseFloat(document.getElementById('geo-height').value);
      if (isNaN(w) || w <= 0 || isNaN(h) || h <= 0) result = 'Enter positive width & height.';
      else result = `Area: ${(w * h).toFixed(4)}, Perimeter: ${(2*(w+h)).toFixed(4)}`;
    }
    document.getElementById('geometry-result').textContent = result;
  }

  // --- 3D CALCULATOR ---
  const threedInputs = {
    sphere: [{id:'radius', label:'Radius', type:'number'}],
    cube: [{id:'side', label:'Side Length', type:'number'}],
    cylinder: [
      {id:'radius', label:'Radius', type:'number'},
      {id:'height', label:'Height', type:'number'}
    ],
  };
  function render3DInputs() {
    const shape = document.getElementById('threed-shape').value;
    const container = document.getElementById('threed-inputs');
    container.innerHTML = '';
    threedInputs[shape].forEach(inp => {
      container.innerHTML += `<input id="threed-${inp.id}" type="${inp.type}" step="any" placeholder="${inp.label}" style="width:100%; margin-bottom:0.4rem; border-radius:6px; border:1px solid #ccc; padding:0.35rem 0.6rem;">`;
    });
  }
  document.getElementById('threed-shape').addEventListener('change', render3DInputs);
  render3DInputs();

  function calc3D() {
    const shape = document.getElementById('threed-shape').value;
    let result = '';
    if (shape === 'sphere') {
      const r = parseFloat(document.getElementById('threed-radius').value);
      if (isNaN(r) || r <= 0) result = 'Enter a positive radius.';
      else result = `Volume: ${(4/3*Math.PI*r**3).toFixed(4)}, Surface Area: ${(4*Math.PI*r**2).toFixed(4)}`;
    } else if (shape === 'cube') {
      const s = parseFloat(document.getElementById('threed-side').value);
      if (isNaN(s) || s <= 0) result = 'Enter positive side length.';
      else result = `Volume: ${(s**3).toFixed(4)}, Surface Area: ${(6*s**2).toFixed(4)}`;
    } else if (shape === 'cylinder') {
      const r = parseFloat(document.getElementById('threed-radius').value);
      const h = parseFloat(document.getElementById('threed-height').value);
      if (isNaN(r) || r <= 0 || isNaN(h) || h <= 0) result = 'Enter positive radius & height.';
      else result = `Volume: ${(Math.PI*r**2*h).toFixed(4)}, Surface Area: ${(2*Math.PI*r*(r+h)).toFixed(4)}`;
    }
    document.getElementById('threed-result').textContent = result;
  }

  // --- FINANCE CALCULATOR ---
  const financeInputs = {
    loan: [
      {id:'amount', label:'Loan Amount', type:'number'},
      {id:'rate', label:'Annual Interest Rate (%)', type:'number'},
      {id:'years', label:'Years', type:'number'}
    ],
    compound: [
      {id:'principal', label:'Principal Amount', type:'number'},
      {id:'rate', label:'Annual Interest Rate (%)', type:'number'},
      {id:'years', label:'Years', type:'number'},
      {id:'frequency', label:'Compoundings/Year', type:'number'}
    ]
  };
  function renderFinanceInputs() {
    const ftype = document.getElementById('finance-type').value;
    const container = document.getElementById('finance-inputs');
    container.innerHTML = '';
    financeInputs[ftype].forEach(inp => {
      container.innerHTML += `<input id="finance-${inp.id}" type="${inp.type}" step="any" placeholder="${inp.label}" style="width:100%; margin-bottom:0.4rem; border-radius:6px; border:1px solid #ccc; padding:0.35rem 0.6rem;">`;
    });
  }
  document.getElementById('finance-type').addEventListener('change', renderFinanceInputs);
  renderFinanceInputs();

  function calcFinance() {
    const ftype = document.getElementById('finance-type').value;
    let result = '';
    if (ftype === 'loan') {
      const P = parseFloat(document.getElementById('finance-amount').value);
      const r = parseFloat(document.getElementById('finance-rate').value) / 100 / 12;
      const n = parseFloat(document.getElementById('finance-years').value) * 12;
      if (isNaN(P) || isNaN(r) || isNaN(n) || P <= 0 || r <= 0 || n <= 0) result = 'Enter all values as positive numbers.';
      else {
        const payment = (P * r) / (1 - Math.pow(1 + r, -n));
        result = `Monthly Payment: $${payment.toFixed(2)}`;
      }
    } else if (ftype === 'compound') {
      const P = parseFloat(document.getElementById('finance-principal').value);
      const r = parseFloat(document.getElementById('finance-rate').value) / 100;
      const t = parseFloat(document.getElementById('finance-years').value);
      const n = parseFloat(document.getElementById('finance-frequency').value);
      if (isNaN(P) || isNaN(r) || isNaN(t) || isNaN(n) || P <= 0 || r <= 0 || t <= 0 || n <= 0) result = 'Enter all values as positive numbers.';
      else {
        const A = P * Math.pow(1 + r / n, n * t);
        result = `Future Value: $${A.toFixed(2)}`;
      }
    }
    document.getElementById('finance-result').textContent = result;
  }

  // --- THEME TOGGLE LOGIC ---
  const themeButton = document.getElementById('themeToggleBtn');
  const themeIcon = document.getElementById('themeIcon');
  const darkClass = 'dark';

  function setTheme(isDark) {
    if (isDark) {
      document.body.classList.add(darkClass);
      themeIcon.textContent = '๐';
      localStorage.setItem('theme', 'dark');
    } else {
      document.body.classList.remove(darkClass);
      themeIcon.textContent = '๐';
      localStorage.setItem('theme', 'light');
    }
  }

  (function initTheme() {
    const storedTheme = localStorage.getItem('theme');
    if (storedTheme === 'dark' || (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      setTheme(true);
    } else {
      setTheme(false);
    }
  })();

  themeButton.addEventListener('click', () => {
    const isDark = !document.body.classList.contains(darkClass);
    setTheme(isDark);
  });

</script>
